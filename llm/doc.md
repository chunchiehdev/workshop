
---

### 後端服務 (Express App) 的核心功能

1.  **`app.post('/api/science-qa', ...)` （接收科學問題的大門）**
    * **它是什麼：** 這是整個問答系統與前端溝通的**主要入口**。當學生在網頁上輸入問題並點擊發送時，前端就會把這個問題以及之前的對話歷史，透過網路，送到這個門口。
    * **它做了什麼：**
        * **收包裹：** 它會接收前端發過來的「包裹」，裡面有三樣東西：學生剛說的「訊息」、所有「聊天記錄」和「當前對話狀態」。
        * **叫醒大腦：** 它拿到這些東西後，會立刻把它們轉交給我們的**「AI 大腦」函數 `processScientificQuestion`** 進行處理。
        * **送回結果：** 等待 `processScientificQuestion` 大腦思考完畢，給出 AI 的回覆和更新後的對話狀態後，這個門口會把這些結果再次打包，透過網路送回給前端網頁。
        * **處理意外：** 如果在處理過程中出錯了（比如網路斷了，或者 AI 大腦當機了），它會給前端一個錯誤訊息，告訴用戶「抱歉，我遇到了一些技術問題。」

---

### AI 大腦的內部運作 (輔助函數)

這部分是 `processScientificQuestion` 函數內部呼叫的各種子函數，它們共同構成了 AI 的思考流程。

1.  **`processScientificQuestion(userMessage, conversationHistory, conversationState)` （AI 大腦總管）**
    * **它是什麼：** 這是 AI 思考的核心，負責根據對話的當前狀態，引導對話流程。
    * **它做了什麼：**
        * **準備好 Gemini 模型：** 它會準備好與 Google Gemini 這個超大型語言模型的溝通工具。
        * **整理聊天歷史：** 它會把所有收到的聊天記錄整理好，轉換成 Gemini 能夠理解的格式，確保 Gemini 知道之前說過什麼，不會「失憶」。它特別聰明地過濾掉一些系統內部對話，並確保對話歷史是以用戶發言開始的。
        * **分派任務：** 根據對話目前處於的「階段」(`flowState`)，它會把任務精確地分派給不同的「小組長」函數去處理：
            * 如果是剛開始或判斷問題是否科學相關，就交給 `assessScienceRelevance` 小組長。
            * 如果是判斷問題是否完整，就交給 `assessQuestionCompleteness` 小組長。
            * 如果是等待學生確認問題是否符合，就交給 `handleConfirmation` 小組長。
            * 如果對話狀態不明，就直接讓學生重新開始。
        * **回報結果：** 收到小組長的處理結果後，它會將 AI 的回覆和更新的對話狀態回報給大門口（`app.post('/api/science-qa', ...)`）。

2.  **`assessScienceRelevance(chat, userMessage, conversationState)` （判斷是否為科學問題小組長）**
    * **它是什麼：** 這個函數專門負責判斷學生提出的問題是不是跟科學有關。
    * **它做了什麼：**
        * **提問 Gemini：** 它會直接向 Gemini 模型提出一個非常明確的問題：「請判斷『${userMessage}』這個問題是不是科學相關的？只回答『科學相關』或『非科學相關』。」
        * **看 Gemini 的答案：** 它會檢查 Gemini 的回覆，如果 Gemini 說「非科學相關」，那麼：
            * 它會告訴學生：「這個問題似乎與科學無關。請您提出科學相關的問題喔！」
            * 然後把對話狀態重置回「初始」，準備接收新的科學問題。
        * **如果是科學問題：** 如果 Gemini 說「科學相關」，那麼它就不再管了，會把這個任務交給下一個小組長 `assessQuestionCompleteness`，讓它去判斷問題夠不夠完整。

3.  **`assessQuestionCompleteness(chat, userMessage, conversationState)` （判斷問題是否完整小組長）**
    * **它是什麼：** 這個函數專門負責判斷學生提出的科學問題是否完整和清晰。
    * **它做了什麼：**
        * **提問 Gemini：** 它會問 Gemini：「請判斷『${userMessage}』這個科學問題是否完整清晰，足以被直接回答？只回答『完整清晰』或『不夠完整』。」
        * **看 Gemini 的答案：**
            * **如果 Gemini 說「完整清晰」：** 太棒了！它會把任務交給 `askForConfirmation` 小組長，讓 AI 去跟學生確認：「我理解你問的問題了，這是不是你真正想問的？」
            * **如果 Gemini 說「不夠完整」：** 嗯，問題還不夠清楚。它會把學生提問不完整的次數加一。
                * **如果這是第 3 次（或更多次）不完整提問，而且之前沒給過指引：** 它會把任務交給 `provide5W1HGuidance` 小組長，讓 AI 主動用 5W1H 原則給學生一些提問範例。
                * **如果還沒到 3 次，或者已經給過指引：** 它會交給 `askForMoreInformation` 小組長，讓 AI 友善地請求學生提供更多資訊。

4.  **`askForConfirmation(chat, userMessage, conversationState)` （確認問題小組長）**
    * **它是什麼：** 這個函數負責向學生確認 AI 對他們問題的理解是否正確。
    * **它做了什麼：**
        * **提問 Gemini：** 它會問 Gemini：「學生問了『${userMessage}』，請你用友善的語氣確認這是否符合他們想問的，並問他們回答『是』或『否』。」
        * **回傳結果：** 它會把 Gemini 生成的確認語句，以及更新後的對話狀態（表示正在等待確認），回傳給總管。

5.  **`askForMoreInformation(chat, userMessage, conversationState)` （請求更多資訊小組長）**
    * **它是什麼：** 這個函數負責在學生問題不完整時，要求他們提供更多細節。
    * **它做了什麼：**
        * **提問 Gemini：** 它會問 Gemini：「學生問了『${userMessage}』，這個問題不完整，請你友善地要求他們提供更多具體資訊，並給出建議。」
        * **回傳結果：** 它會把 Gemini 生成的請求補充資訊語句，以及更新後的對話狀態，回傳給總管。注意，這裡的狀態會回到 `ASSESSING_RELEVANCE`，表示下次學生輸入時會重新從判斷相關性開始。

6.  **`provide5W1HGuidance(chat, userMessage, conversationState)` （提供 5W1H 指引小組長）**
    * **它是什麼：** 當學生多次提問不完整時，這個函數會主動提供基於 5W1H 的問題範例，幫助學生更好地提問。
    * **它做了什麼：**
        * **提問 Gemini：** 它會告訴 Gemini：「學生已經問了多次不完整問題，最近一次是『${userMessage}』。請根據 5W1H 原則，為學生提供 3 個具體的問題範例。」
        * **回傳結果：** 它會把 Gemini 生成的 5W1H 建議語句，以及更新後的對話狀態（表示已提供指引，並等待確認），回傳給總管。

7.  **`handleConfirmation(chat, userMessage, conversationState, conversationHistory)` （處理確認結果小組長）**
    * **它是什麼：** 這個函數負責處理學生對於「是否符合想問問題」的「是」或「否」回答。
    * **它做了什麼：**
        * **提問 Gemini：** 它會問 Gemini：「用戶對確認問題的回答是『${userMessage}』，請判斷這是肯定回答還是否定回答，只回答『肯定』或『否定』。」
        * **看 Gemini 的答案：**
            * **如果 Gemini 說「肯定」：** 學生確認了！它會把任務交給 `provideFinalAnswer` 小組長，讓 AI 開始回答這個問題。
            * **如果 Gemini 說「否定」：** 學生不滿意！它會告訴學生：「好的，讓我們重新開始。請重新提出您的科學問題。」並把對話狀態重置回「初始」。

8.  **`provideFinalAnswer(chat, question, conversationState)` （提供最終答案小組長）**
    * **它是什麼：** 這個函數是最終的回答者，當學生問題被確認後，它會提供詳細的科學答案。
    * **它做了什麼：**
        * **提問 Gemini：** 它會告訴 Gemini：「現在請回答學生的科學問題：『${question}』。請提供準確、適合學生理解的解釋，並在回答後加上『如果您還有其他科學問題，請隨時提問！』」
        * **回傳結果：** 它會把 Gemini 生成的詳細答案，以及更新後的對話狀態（表示對話結束），回傳給總管。

---

### 健康檢查 (額外功能)

1.  **`app.get('/api/health', ...)` （健康檢查入口）**
    * **它是什麼：** 這是一個簡單的「檢查站」，用來確認服務器是否正常運行。
    * **它做了什麼：** 當有人訪問這個地址時，它就簡單地回覆一句「我很好，正在運行！」。
